// Code generated by normalizer-generator. DO NOT EDIT.
//
// This file was automatically generated from OCSF schema and field mappings.

package generated

import (
	"context"
	"encoding/json"
	"fmt"
	"strings"

	"github.com/telhawk-systems/telhawk-stack/core/internal/model"
	"github.com/telhawk-systems/telhawk-stack/core/pkg/ocsf"
	"github.com/telhawk-systems/telhawk-stack/core/pkg/ocsf/events/iam"
	"github.com/telhawk-systems/telhawk-stack/core/pkg/ocsf/objects"
)

// AuthenticationNormalizer normalizes authentication events to OCSF format
type AuthenticationNormalizer struct{}

// NewAuthenticationNormalizer creates a new normalizer
func NewAuthenticationNormalizer() *AuthenticationNormalizer {
	return &AuthenticationNormalizer{}
}

// Supports checks if this normalizer handles the given event
func (n *AuthenticationNormalizer) Supports(format, sourceType string) bool {
	if format != "json" {
		return false
	}
	st := strings.ToLower(sourceType)
	return strings.Contains(st, "auth") || 
	       strings.Contains(st, "login") || 
	       strings.Contains(st, "logon") || 
	       strings.Contains(st, "session") || 
	       strings.Contains(st, "sso") || 
	       strings.Contains(st, "oauth") || 
	       strings.Contains(st, "saml") || 
	       strings.Contains(st, "ldap") || 
	       strings.Contains(st, "kerberos") || 
	       strings.Contains(st, "ad_auth")
}

// Normalize converts raw event to OCSF authentication
func (n *AuthenticationNormalizer) Normalize(ctx context.Context, envelope *model.RawEventEnvelope) (*ocsf.Event, error) {
	var payload map[string]interface{}
	if err := json.Unmarshal(envelope.Payload, &payload); err != nil {
		return nil, fmt.Errorf("decode payload: %%w", err)
	}

	activityID := n.determineActivityID(payload)
	event := iam.NewAuthentication(activityID)

	event.Time = ExtractTimestamp(payload, envelope.ReceivedAt)
	event.ObservedTime = envelope.ReceivedAt

	// Extract common fields
	if user := ExtractUser(payload); user != nil {
		event.Actor = &objects.Actor{User: user}
	}

	event.StatusID, event.Status = ExtractStatus(payload)
	event.SeverityID, event.Severity = ExtractSeverity(payload)

	event.Metadata.LogProvider = envelope.Source
	event.Raw = ocsf.RawDescriptor{Format: envelope.Format, Data: payload}

	return &event.Event, nil
}

func (n *AuthenticationNormalizer) determineActivityID(payload map[string]interface{}) int {
	action := strings.ToLower(ExtractString(payload, "action", "event_type", "activity"))

	if strings.Contains(action, "logout") || strings.Contains(action, "logoff") || strings.Contains(action, "signout") || strings.Contains(action, "sign_out") {
		return 1 // logoff
	} else if strings.Contains(action, "login") || strings.Contains(action, "logon") || strings.Contains(action, "signin") || strings.Contains(action, "sign_in") {
		return 2 // logon
	}
	return 0 // Unknown
}

