#!/bin/bash
# Wrapper for thawk CLI using dev container
# Builds thawk inside the dev container and executes commands

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Check if dev container is running
is_dev_running() {
    docker ps --filter "name=telhawk-dev" --filter "status=running" --format "{{.Names}}" | grep -q "telhawk-dev"
}

# Build thawk inside dev container
build_thawk() {
    if ! docker exec telhawk-dev test -f /app/bin/thawk 2>/dev/null; then
        echo "Building thawk..." >&2
        docker exec telhawk-dev bash -c "cd /app/cli && go build -o /app/bin/thawk ."
        echo "âœ“ Built thawk" >&2
    fi
}

# Parse arguments to detect rules directory (--from-rules flag or positional for list-rules)
parse_rules_path() {
    local args=("$@")
    local rules_path=""
    local modified_args=()
    local in_list_rules=false

    # Check if this is a "seeder list-rules" command
    for arg in "${args[@]}"; do
        if [[ "$arg" == "list-rules" ]]; then
            in_list_rules=true
            break
        fi
    done

    for ((i=0; i<${#args[@]}; i++)); do
        if [[ "${args[$i]}" == "--from-rules" ]] && [[ $((i+1)) -lt ${#args[@]} ]]; then
            # Handle --from-rules flag
            local path="${args[$((i+1))]}"
            if [[ ! "$path" =~ ^/ ]]; then
                rules_path="$(cd "$PROJECT_ROOT" && realpath "$path")"
                modified_args+=("--from-rules")
                modified_args+=("/rules")
                ((i++))
            else
                modified_args+=("${args[$i]}")
            fi
        elif [[ "$in_list_rules" == true ]] && [[ "${args[$i]}" != "seeder" ]] && [[ "${args[$i]}" != "list-rules" ]] && [[ "${args[$i]}" != -* ]]; then
            # Handle positional argument for list-rules (if it's not a flag)
            local path="${args[$i]}"
            if [[ ! "$path" =~ ^/ ]]; then
                rules_path="$(cd "$PROJECT_ROOT" && realpath "$path")"
                modified_args+=("/rules")
            else
                modified_args+=("${args[$i]}")
            fi
        else
            modified_args+=("${args[$i]}")
        fi
    done

    # Export results
    export RULES_PATH="$rules_path"
    export MODIFIED_ARGS=("${modified_args[@]}")
}

# Main logic
main() {
    # Ensure we're in the project root
    cd "$PROJECT_ROOT"

    # Check if dev container is running
    if ! is_dev_running; then
        echo "Error: telhawk-dev container not running" >&2
        echo "Start it with: docker-compose -f docker-compose.dev.yml up -d" >&2
        exit 1
    fi

    # Build thawk if needed
    build_thawk

    # Parse arguments to detect rules path
    parse_rules_path "$@"

    # Build command to execute
    local cmd=(/app/bin/thawk "${MODIFIED_ARGS[@]}")

    # Set environment variables for thawk
    local env_vars=(
        -e "THAWK_AUTH_URL=http://localhost:8080"
        -e "THAWK_INGEST_URL=http://localhost:8088"
        -e "THAWK_QUERY_URL=http://localhost:8082"
        -e "THAWK_RULES_URL=http://localhost:8085"
        -e "THAWK_ALERTING_URL=http://localhost:8085"
    )

    # If .hec-token file exists, set HEC_TOKEN env var
    if [[ -f "$PROJECT_ROOT/.hec-token" ]]; then
        local token=$(cat "$PROJECT_ROOT/.hec-token")
        env_vars+=(-e "HEC_TOKEN=$token")
    fi

    # Execute thawk command in dev container
    docker exec "${env_vars[@]}" telhawk-dev "${cmd[@]}"
}

main "$@"
