openapi: 3.1.0
info:
  title: TelHawk Query API
  version: 0.1.0
  description: |
    REST API surface for executing searches, managing alerts and dashboards,
    and exporting data from TelHawk Stack. All application endpoints require
    a JWT access token generated by the Auth service unless noted otherwise.
servers:
  - url: https://api.telhawk.local
    description: Example environment endpoint
security:
  - bearerAuth: []
tags:
  - name: Search
    description: Execute SPL-compatible queries against normalized event data
  - name: Alerts
    description: Manage saved searches that emit notifications when matched
  - name: Dashboards
    description: Retrieve dashboard definitions consumed by the web UI
  - name: Export
    description: Request bulk exports for offline processing
  - name: Health
    description: Service level health and readiness probes
paths:
  /api/v1/search:
    post:
      tags: [Search]
      summary: Execute a search query
      description: |
        Runs a query against the TelHawk data store using a subset of Splunk SPL.
        The request pipeline validates the caller using the Auth service, normalizes
        the requested time range, and streams results back in the requested sort
        order. The initial implementation returns a single page of results; future
        versions may add cursor-based pagination.
      operationId: executeSearch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
            examples:
              basic:
                summary: Basic malware search
                value:
                  query: "index=ocsf endpoint where class = 'malware'"
                  time_range:
                    from: "2024-03-01T00:00:00Z"
                    to: "2024-03-01T06:00:00Z"
                  limit: 100
                  sort:
                    field: "event_time"
                    order: "desc"
      responses:
        '200':
          description: Search executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
              examples:
                sample:
                  summary: Response with 2 matching records
                  value:
                    request_id: "1caa47dc-4dd7-4bc7-b135-9b6b858b4b2c"
                    latency_ms: 87
                    result_count: 2
                    results:
                      - event_time: "2024-03-01T01:32:09Z"
                        log_source: "edr"
                        class: "malware"
                        severity: "high"
                        host: "workstation-17"
                      - event_time: "2024-03-01T02:17:44Z"
                        log_source: "edr"
                        class: "malware"
                        severity: "medium"
                        host: "workstation-22"
        '400':
          description: Invalid query payload or unsupported SPL features
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing or invalid JWT access token
        '403':
          description: Caller lacks permission to run the requested query
        '500':
          description: Internal error running the query pipeline
  /api/v1/alerts:
    get:
      tags: [Alerts]
      summary: List alerts
      description: Retrieves saved alert definitions filtered by optional status and severity filters.
      operationId: listAlerts
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [active, firing, acknowledged, resolved]
        - in: query
          name: severity
          schema:
            type: string
            enum: [low, medium, high, critical]
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - in: query
          name: cursor
          schema:
            type: string
          description: Cursor token for pagination
      responses:
        '200':
          description: List of alerts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertListResponse'
        '401':
          description: Missing or invalid JWT access token
        '500':
          description: Unable to retrieve alerts
    post:
      tags: [Alerts]
      summary: Create or update an alert definition
      description: Creates a new alert definition or updates an existing one when `id` is supplied in the payload.
      operationId: upsertAlert
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertRequest'
      responses:
        '201':
          description: Alert created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'
        '200':
          description: Alert updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'
        '400':
          description: Invalid alert definition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing or invalid JWT access token
        '500':
          description: Internal error persisting alert
  /api/v1/alerts/{alertId}:
    get:
      tags: [Alerts]
      summary: Retrieve a single alert definition
      operationId: getAlert
      security:
        - bearerAuth: []
      parameters:
        - name: alertId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Alert definition returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'
        '404':
          description: Alert not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing or invalid JWT access token
    patch:
      tags: [Alerts]
      summary: Update mutable alert fields
      description: Allows status transitions and metadata updates without resubmitting the full definition.
      operationId: patchAlert
      security:
        - bearerAuth: []
      parameters:
        - name: alertId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertPatchRequest'
      responses:
        '200':
          description: Alert updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'
        '400':
          description: Invalid patch payload
        '404':
          description: Alert not found
        '401':
          description: Missing or invalid JWT access token
  /api/v1/dashboards:
    get:
      tags: [Dashboards]
      summary: List available dashboards
      operationId: listDashboards
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dashboard list response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardListResponse'
        '401':
          description: Missing or invalid JWT access token
        '500':
          description: Unable to retrieve dashboards
  /api/v1/dashboards/{dashboardId}:
    get:
      tags: [Dashboards]
      summary: Retrieve a dashboard definition
      operationId: getDashboard
      security:
        - bearerAuth: []
      parameters:
        - name: dashboardId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Dashboard definition returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dashboard'
        '404':
          description: Dashboard not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing or invalid JWT access token
  /api/v1/export:
    post:
      tags: [Export]
      summary: Request a data export job
      description: Creates a background export job that will hydrate a downloadable artifact.
      operationId: requestExport
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportRequest'
      responses:
        '202':
          description: Export job accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'
        '400':
          description: Invalid export definition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing or invalid JWT access token
        '500':
          description: Internal error creating export job
  /healthz:
    get:
      tags: [Health]
      summary: Liveness probe
      description: Returns health metadata for container orchestrators.
      operationId: healthz
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    TimeRange:
      type: object
      required: [from, to]
      properties:
        from:
          type: string
          format: date-time
          description: Inclusive start time in RFC3339
        to:
          type: string
          format: date-time
          description: Exclusive end time in RFC3339
    SortOptions:
      type: object
      properties:
        field:
          type: string
          description: Field to sort by
        order:
          type: string
          enum: [asc, desc]
          default: desc
    SearchRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
          description: SPL subset query string
        time_range:
          $ref: '#/components/schemas/TimeRange'
        limit:
          type: integer
          minimum: 1
          maximum: 10000
          default: 100
        sort:
          $ref: '#/components/schemas/SortOptions'
        include_fields:
          type: array
          items:
            type: string
          description: Optional allowlist of fields to return
    SearchResponse:
      type: object
      required: [request_id, result_count, results]
      properties:
        request_id:
          type: string
          format: uuid
        latency_ms:
          type: integer
          minimum: 0
        result_count:
          type: integer
          minimum: 0
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchRecord'
    SearchRecord:
      type: object
      additionalProperties: true
      description: Normalized event record
      properties:
        event_time:
          type: string
          format: date-time
        class:
          type: string
        severity:
          type: string
        host:
          type: string
        log_source:
          type: string
    Alert:
      type: object
      required: [id, name, query, severity, schedule, status]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        query:
          type: string
        severity:
          type: string
          enum: [low, medium, high, critical]
        schedule:
          type: object
          properties:
            interval_minutes:
              type: integer
              minimum: 1
            lookback_minutes:
              type: integer
              minimum: 1
        status:
          type: string
          enum: [active, firing, acknowledged, resolved]
        last_triggered_at:
          type: string
          format: date-time
        owner:
          type: string
    AlertRequest:
      allOf:
        - $ref: '#/components/schemas/Alert'
      required: [name, query, severity, schedule]
    AlertPatchRequest:
      type: object
      properties:
        status:
          type: string
          enum: [acknowledged, resolved]
        owner:
          type: string
    AlertListResponse:
      type: object
      required: [alerts]
      properties:
        alerts:
          type: array
          items:
            $ref: '#/components/schemas/Alert'
        next_cursor:
          type: string
          nullable: true
    Dashboard:
      type: object
      required: [id, name, widgets]
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        widgets:
          type: array
          items:
            type: object
            additionalProperties: true
    DashboardListResponse:
      type: object
      required: [dashboards]
      properties:
        dashboards:
          type: array
          items:
            $ref: '#/components/schemas/Dashboard'
    ExportRequest:
      type: object
      required: [query, format]
      properties:
        query:
          type: string
        time_range:
          $ref: '#/components/schemas/TimeRange'
        format:
          type: string
          enum: [json, csv]
        compression:
          type: string
          enum: [none, gzip]
          default: gzip
        notification_channel:
          type: string
          description: Optional notification channel id
    ExportResponse:
      type: object
      required: [export_id, status]
      properties:
        export_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, completed, failed]
        expires_at:
          type: string
          format: date-time
          description: When the downloadable artifact expires
    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
        version:
          type: string
        uptime_seconds:
          type: integer
