# CLAUDE.md

Guidance for code agents working in this repository. Keep commits clean and avoid AI attribution.

## Critical Instructions
- Do not add "Co-Authored-By/Generated by …" footers to commits.
- Prefer linking to existing docs over repeating content.
- Use `docs/README.md` as the navigation root.

## Project Overview

TelHawk Stack is an OCSF-compatible SIEM in Go with Splunk-compatible ingestion and OpenSearch storage.

**V2 Architecture (5 services):**
```
                    ┌─────────────────────────────────────────┐
                    │                  NATS                   │
                    │         (Message Broker)                │
                    └──────┬─────────────┬───────────────────┘
                           │             │
    ┌──────────────────────┼─────────────┼──────────────────────┐
    │                      ↓             ↓                      │
    │  ┌─────────┐    ┌─────────┐   ┌─────────┐   ┌─────────┐  │
    │  │ ingest  │    │ search  │   │ respond │   │   web   │  │
    │  └────┬────┘    └────┬────┘   └────┬────┘   └────┬────┘  │
    │       │              │             │             │        │
    │       ↓              ↓             ↓             │        │
    │  ┌─────────────────────┐    ┌───────────┐       │        │
    │  │     OpenSearch      │    │ PostgreSQL│       │        │
    │  └─────────────────────┘    └───────────┘       │        │
    │                                    ↑             │        │
    │                             ┌──────┴─────┐      │        │
    │                             │authenticate│←─────┘        │
    │                             └────────────┘               │
    └──────────────────────────────────────────────────────────┘
```

| Service | Purpose | Port |
|---------|---------|------|
| `authenticate` | Identity, sessions, JWT/HEC tokens | 8080 |
| `ingest` | Event ingestion + OpenSearch writes | 8088 |
| `search` | Ad-hoc queries + correlation | 8082 |
| `respond` | Detection rules, alerts, cases | 8085 |
| `web` | Frontend UI + API gateway | 3000 |

See `docs/SERVICES.md` for detailed service descriptions.

## Development Commands

### Building and Testing

```bash
# Build one service
cd <service> && go build -o ../bin/<service> ./cmd/<service>

# Examples:
cd authenticate && go build -o ../bin/authenticate ./cmd/authenticate
cd ingest && go build -o ../bin/ingest ./cmd/ingest
cd search && go build -o ../bin/search ./cmd/search
cd respond && go build -o ../bin/respond ./cmd/respond

# Run tests
go test ./...
```

### TelHawk CLI (thawk)

The `thawk` CLI provides command-line access to all TelHawk services. Use the smart wrapper script:

```bash
# Authentication
./scripts/thawk auth login -u admin -p admin123
./scripts/thawk auth whoami

# Detection rules
./scripts/thawk rules list
./scripts/thawk rules get <rule-id>
./scripts/thawk rules create rules/failed_logins.json

# Alerts and cases
./scripts/thawk alerts list
./scripts/thawk alerts cases list

# Event seeding
./scripts/thawk seeder run --from-rules ./alerting/dist/rules/

# All commands
./scripts/thawk --help
```

**How it works:** The wrapper automatically builds thawk (if Go is available) or rebuilds the devtools image, then executes commands via the devtools container with proper network access and environment variables.

### Docker / Devtools

See `docs/LOCAL_DEVELOPMENT.md` and `docs/HELPER_SCRIPTS.md` for detailed usage.

### Internal Access & Scripts

Use the `./scripts/curl.sh` wrapper to access internal services from your host machine.

**Quick Start:**
```bash
# Access internal services that aren't exposed to the host
./scripts/curl.sh http://respond:8085/api/v1/alerts?page=1&limit=5
./scripts/curl.sh http://respond:8085/api/v1/schemas
./scripts/curl.sh -s http://search:8082/health | jq '.'
```

**How it works:** The script runs curl inside a Docker container connected to the TelHawk network, allowing access to internal services (authenticate, search, respond, etc.) that are not exposed on localhost.

**File locations:**
- Scripts in `./tmp/` are accessible at `/tmp/` in the container (read/write)
- Scripts in `./scripts/` are accessible at `/scripts/` in the container (read-only)

### Database Migrations

Services use golang-migrate for database schema management:

```bash
# Migrations are automatically run on service startup
# Migration files: <service>/migrations/*.sql (or <service>/dist/migrations/*.sql)

# To manually run migrations (authenticate example):
cd authenticate
migrate -database "postgres://telhawk:password@localhost:5432/telhawk_auth?sslmode=disable" -path migrations version
migrate -database "postgres://telhawk:password@localhost:5432/telhawk_auth?sslmode=disable" -path migrations up
migrate -database "postgres://telhawk:password@localhost:5432/telhawk_auth?sslmode=disable" -path migrations down 1
```

### Generating Test Data (Event Seeder)

The event seeder generates realistic OCSF events for development and testing.

**Quick Start (Recommended):**

```bash
# Run the first-time seeding script (handles everything automatically)
./scripts/first-time-seed.sh
```

**Manual seeding:**

```bash
# Generate events from detection rules directory:
./bin/thawk seeder run --token YOUR_TOKEN --from-rules ./alerting/dist/rules/

# List available rules and their support status:
./bin/thawk seeder list-rules ./alerting/dist/rules/
```

## Architecture

See `docs/SERVICES.md` for current service flow and summaries.

### Services

| Service | Responsibility | Storage |
|---------|----------------|---------|
| `authenticate` | Auth, sessions, JWT/HEC tokens | PostgreSQL |
| `ingest` | HEC endpoint, OCSF normalization, OpenSearch writes | OpenSearch (write) |
| `search` | Ad-hoc queries, correlation evaluation | OpenSearch (read) |
| `respond` | Detection rules, alerts, cases | PostgreSQL |
| `web` | React UI, API gateway | Stateless |

### Supporting Infrastructure

- **OpenSearch** (9200): Time-series event storage
- **PostgreSQL** (5432): Relational data (users, rules, alerts, cases)
- **NATS** (4222): Async message broker
- **Redis** (6379): Rate limiting, caching

## Code Architecture

### Event Pipeline (Ingest → OpenSearch)

1. **Ingest Service** receives raw events via HEC endpoint (`/services/collector/event`)
   - Validates HEC token via authenticate service (with 5-min caching)
   - IP-based and token-based rate limiting (Redis-backed)
   - **Normalizes events to OCSF format**:
     - Registry pattern matches raw event format/source_type to normalizer
     - 77 auto-generated normalizers (one per OCSF class) in `ingest/internal/normalizer/generated/`
     - HECNormalizer as fallback for generic HEC events
     - Validation chain ensures OCSF compliance
     - Failed events → Dead Letter Queue (file-based at `/var/lib/telhawk/dlq`)
   - Writes directly to OpenSearch (bulk indexing)
   - Index pattern: `telhawk-events-YYYY.MM.DD`

**Key Files:**
- `ingest/internal/pipeline/pipeline.go`: Orchestrates normalization and validation
- `ingest/internal/normalizer/normalizer.go`: Registry and interface definitions
- `ingest/internal/normalizer/generated/`: Auto-generated normalizers (77 OCSF classes)
- `ingest/internal/handlers/hec_handler.go`: HEC endpoint implementation
- `ingest/internal/storage/opensearch.go`: OpenSearch client and bulk operations
- `common/ocsf/`: Shared OCSF event structures and types

### Authentication Flow

1. User login (`POST /api/v1/auth/login`) → returns JWT access token + refresh token
2. Access token used in `Authorization: Bearer <token>` header
3. Token validation endpoint (`POST /api/v1/auth/validate`) called by other services
4. Refresh tokens stored in PostgreSQL sessions table with revocation support
5. HEC tokens stored separately with user association
6. All auth events forwarded to ingest service as OCSF Authentication events (class_uid: 3002)

**Key Files:**
- `authenticate/internal/repository/postgres.go`: Database operations
- `authenticate/pkg/tokens/jwt.go`: JWT generation and validation
- `authenticate/migrations/001_init.up.sql`: Database schema

### API Conventions (JSON:API)

All new and modernized HTTP APIs follow the JSON:API 1.0 specification (https://jsonapi.org/format/):
- Content type: `application/vnd.api+json` for requests and responses
- Top-level members: `data`, `errors`, `meta`, `links`
- Resources: `type`, `id`, `attributes`, optional `relationships`
- Pagination: `page[number]`, `page[size]` (or cursor when specified)
- Filtering and sorting use JSON:API conventions (e.g., `filter[...]`, `sort`)
- Errors use JSON:API error objects with `status`, `code`, `title`, `detail`

### OCSF Normalization

The system uses a code generator approach for OCSF compliance:

1. **OCSF Schema** (`ocsf-schema/`): Git submodule tracking OCSF 1.1.0 schema
2. **OCSF Type Generator** (`tools/ocsf-generator/`): Generates Go structs for OCSF events and objects
3. **Normalizer Generator** (`tools/normalizer-generator/`): Generates normalizers for each OCSF class
4. **Generated OCSF Types** (`common/ocsf/`): Shared OCSF event structures used across services
5. **Generated Normalizers** (`ingest/internal/normalizer/generated/`): One normalizer per OCSF class (77 total)
6. **Runtime**: Registry in ingest service matches events to normalizers based on source_type patterns

**Key Files:**
- `tools/ocsf-generator/main.go`: OCSF type generator
- `tools/normalizer-generator/main.go`: Normalizer code generator
- `common/ocsf/`: Shared OCSF event types and objects (generated)
- `ingest/internal/normalizer/registry.go`: Normalizer registration
- `ingest/internal/normalizer/generated/`: Auto-generated normalizers

### Configuration Management

All services follow a consistent pattern:
- **YAML config file** embedded in Docker images at `/etc/telhawk/<service>/config.yaml`
- **Environment variables** override YAML settings (12-factor app compliant)
- **Viper** library for config loading
- **No CLI arguments** for configuration

Environment variable naming: `<SERVICE>_<SECTION>_<KEY>`
Examples:
- `AUTHENTICATE_SERVER_PORT=8080`
- `INGEST_AUTH_URL=http://authenticate:8080`
- `SEARCH_OPENSEARCH_PASSWORD=secret`

**Key Files:**
- `authenticate/config.yaml`, `ingest/config.yaml`, etc.: Default configurations
- `docker-compose.yml`: Shows environment variable overrides
- `.env.example`: Template for local overrides

## TLS/Certificate Management

The stack uses mutual TLS (mTLS) for service-to-service communication:

1. **Certificate Generation**: Init containers create certificates before services start
2. **Certificate Storage**: Shared Docker volumes (`telhawk-certs:/certs`)
3. **TLS Configuration**: Controlled via environment variables
   - `<SERVICE>_TLS_ENABLED=true/false`: Enable TLS for each service
   - `<SERVICE>_TLS_SKIP_VERIFY=true/false`: Skip cert verification (dev only)

**Key Files:**
- `certs/generator/Dockerfile`: Go service certificate generator
- `docs/TLS_CONFIGURATION.md`: Detailed TLS setup guide

## Important Implementation Details

### Database Schema Patterns

**PostgreSQL - Immutability Pattern**:
The system follows an immutable database pattern for audit trails and versioning:

**Core Principles**:
- **UUID v7**: All new IDs use `uuid.NewV7()` for time-ordered UUIDs
- **Lifecycle Timestamps**: Use `disabled_at`, `deleted_at`, `hidden_at` instead of boolean flags
- **Append-Only Pattern**: INSERT for new content, UPDATE only for lifecycle timestamps
- **No Physical Deletes**: Soft delete with `deleted_at` timestamp
- **Immutable Versioning**: Content changes create new rows with same stable ID but new version ID

**Service databases**:
- `authenticate`: users, hec_tokens, sessions
- `respond`: detection_schemas (rules), alerts, cases

**OpenSearch**:
- Daily time-based indices: `telhawk-events-YYYY.MM.DD`, `telhawk-alerts-YYYY.MM.DD`
- OCSF-optimized mappings (nested objects for actors, devices, etc.)
- Query pattern: `telhawk-events-*` for searches across all indices

### Error Handling and Reliability

**Dead Letter Queue (DLQ)**:
- File-based storage at `/var/lib/telhawk/dlq`
- Captures normalization and storage failures
- API endpoints: `GET /dlq/list`, `POST /dlq/purge`

**Retry Strategy**:
- 3 attempts with exponential backoff
- Retries on 5xx, 429, network errors
- No retry on 4xx client errors (except 429)

**Rate Limiting**:
- Redis-backed sliding window algorithm
- IP-based (pre-auth) and token-based (post-auth)
- Returns HTTP 429 when exceeded

### Observability

**Health Checks**: All services expose `/healthz` or `/readyz` endpoints

**Metrics** (Prometheus format at `/metrics`):
- Event processing: `events_total`, `normalization_duration`, `storage_duration`
- Queue depth: `queue_depth`, `queue_capacity`
- Rate limiting: `rate_limit_hits_total`

## CLI Tool (thawk)

The CLI uses Cobra for command structure:

```bash
# Authentication
thawk auth login -u <username> -p <password>
thawk auth whoami
thawk auth logout

# HEC token management
thawk token create --name <token-name>
thawk token list
thawk token revoke <token-id>

# Event ingestion
thawk ingest send --message "event text" --token <hec-token>

# Search queries
thawk search --query "severity:high" --from 1h
```

**Key Files:**
- `cli/cmd/root.go`: Root command and global flags
- `cli/cmd/auth.go`, `cli/cmd/token.go`, etc.: Subcommands
- `cli/internal/config/config.go`: CLI configuration (~/.thawk/config.yaml)

## Code Generation

### OCSF Normalizer Generator

Location: `tools/normalizer-generator/`

Regenerate normalizers after OCSF schema updates:

```bash
cd tools/normalizer-generator
go run main.go

# Output: ingest/internal/normalizer/generated/*.go (77 files)
```

## Common Development Patterns

### Adding a New Service

1. Create service directory with standard structure:
   ```
   newservice/
   ├── cmd/newservice/main.go
   ├── internal/
   │   ├── config/config.go
   │   ├── handlers/handlers.go
   │   └── ...
   ├── Dockerfile
   ├── config.yaml
   └── go.mod
   ```

2. Add to `docker-compose.yml` with health checks and dependencies
3. Add TLS certificate generation if needed
4. Follow environment variable naming: `NEWSERVICE_SECTION_KEY`

### Adding Database Migrations

1. Create numbered migration files in `<service>/migrations/`:
   - `NNN_description.up.sql`
   - `NNN_description.down.sql`

2. Migrations run automatically on service startup
3. Use PostgreSQL best practices: indexes, constraints, comments

## Security Considerations

**Network Exposure:**
- **Minimal Attack Surface**: Only web (3000) and ingest (8088) exposed externally
- **No Direct Service Access**: authenticate, search, respond services ONLY accessible via Docker network
- **Self-Registration Disabled**: User accounts must be created by administrators

**Authentication & Authorization:**
- JWT secrets MUST be set via `AUTHENTICATE_JWT_SECRET` environment variable
- HEC tokens are random UUIDs, stored hashed in database
- All auth events forwarded to SIEM for audit trail

**Transport Security:**
- TLS MUST be enabled in production (`*_TLS_ENABLED=true`)
- PostgreSQL uses SSL/TLS in production (`sslmode=require`)
- OpenSearch uses TLS with client certificates

## Documentation

Key documentation files:
- `README.md`: Overview, quick start, architecture
- `docs/SERVICES.md`: Service descriptions and architecture
- `docs/CONFIGURATION.md`: Complete configuration reference
- `docs/CLI_CONFIGURATION.md`: CLI usage guide
- `docs/ARCHITECTURE_V2.md`: V2 architecture details

## Web Frontend

The web UI is a React application with:
- **Backend**: Go server in `web/backend/` (port 3000)
- **Frontend**: React app in `web/frontend/`
- **Build**: Frontend built and served as static files by backend
- **Features**: Search console, event table, OCSF field inspection, severity color-coding

Frontend development:
```bash
cd web/frontend
npm install
npm start  # Development server
npm run build  # Production build
```

## Default Credentials

**Database (development)**:
- PostgreSQL: `telhawk:telhawk-auth-dev@auth-db:5432/telhawk_auth`
- OpenSearch: `admin:TelHawk123!`

**Default User (created by migration)**:
- Username: `admin`
- Password: `admin123`
- Email: `admin@telhawk.local`
- Roles: `[admin]`
